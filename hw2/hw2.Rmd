---
title: "Biostat 203B Homework 2"
subtitle: Due Feb 6 @ 11:59PM
author: Rayo Suseno
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup, message=F}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, cache.lazy = FALSE)
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/mnt/mimiciv/1.0"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-1.0"
}
```

In this exercise, we use tidyverse (ggpot2, dplyr, etc) to explore the [MIMIC-IV](https://mimic.mit.edu/docs/iv/) data introduced in [homework 1](https://ucla-biostat-203b.github.io/2022winter/hw/hw1/hw1.html) and to build a cohort of ICU stays.

```{r}
# tree -s -L 2 /Users/huazhou/Documents/Box\ Sync/MIMIC/mimic-iv-1.0
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading plain text data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. 

Which function is fastest? Is there difference in the (default) parsed data types? (Hint: R function `system.time` measures run times.)

For later questions, we stick to the tidyverse.

**Solution**
```{r}
system.time(read.csv(file="/mnt/mimiciv/1.0/core/admissions.csv.gz"))
system.time(read_csv("/mnt/mimiciv/1.0/core/admissions.csv.gz"))
system.time(fread(file="/mnt/mimiciv/1.0/core/admissions.csv.gz"))
```

fread is the fastest, whereas the R read.csv is the slowest. Tidyverse's read_csv is just a little slower than fread's.


## Q2. ICU stays

`icustays.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/icustays.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `icustatys.csv.gz` as a tibble `icustays_tble`. 
**Solution**
```{r}
icustays_tble <- read_csv("/mnt/mimiciv/1.0/icu/icustays.csv.gz") %>% 
  print(width=Inf)
```

2. How many unique `subject_id`? Can a `subject_id` have multiple ICU stays? 
```{r}
by_id <- group_by(icustays_tble, subject_id)
by_id
```
There are 53,150 unique subject_id, whereas there are 76,540 entries in this ICU admission, which means a subject_id can have multiple ICU stays.


3. For each `subject_id`, let's only keep the first ICU stay in the tibble `icustays_tble`.
```{r}
icustays_tble <- icustays_tble %>% 
  arrange(intime) %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  print(width = Inf)
```

## Q3. `admission` data

Information of the patients admitted into hospital is available in `admissions.csv.gz`. See <https://mimic.mit.edu/docs/iv/modules/core/admissions/> for details of each field in this file. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/core/admissions.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `admissions.csv.gz` as a tibble `admissions_tble`.
```{r}
admissions_tble <- read_csv("/mnt/mimiciv/1.0/core/admissions.csv.gz")
admissions_tble
```

2. Let's only keep the admissions that have a match in `icustays_tble` according to `subject_id` and `hadmi_id`.
```{r}
admissions_tble <- inner_join(admissions_tble, 
                              icustays_tble, 
                              by=c("subject_id", "hadm_id")) %>% 
  select(-c(16:21)) %>% 
  print(width = Inf)
```

3. Summarize the following variables by graphics. 

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  

```{r}
admissions_tble %>% 
  ggplot(aes(x = year(admittime))) + 
  geom_freqpoly(binwidth=1) +
  ggtitle("Number of patients admitted throughout the year") +
  xlab("Year") + ylab("Number of patients")
```
Based on the graph above, it seems like the year with highest admission is 2145. Additionally, starting from the year 2130 to 2189, there seems to be a stable high admission, which then dies down at 2190. Perhaps there was a pandemic during these 59 years period?

```{r}
admissions_tble %>% 
  ggplot(aes(x = month(admittime, label = TRUE))) + 
  geom_bar() +
  ggtitle("Number of patients admitted throughout different months") +
  xlab("Month") + ylab("Number of patients") 
```
From the graph above, February has the lowest admissions rate which somewhat make sense since it has the lowest number of day (either 28 or 29), making it statistically less likely for a patient to be admitted during the month of February. I think it would be helpful to zoom in so that we get a closer look:
```{r}
admissions_tble %>% 
  ggplot(aes(x = month(admittime, label = TRUE))) + 
  geom_bar() +
  ggtitle("Number of patients admitted throughout different months") +
  xlab("Month") + ylab("Number of patients") +
  coord_cartesian(ylim = c(4000, 5000)) 
```
Here, we can say that August has the highest admissions rate throughout the many years of the hospital admission. April, June, September, and November seem to be on average a little lower than the other months (except February).

```{r}
admissions_tble %>% 
  ggplot(aes(x = mday(admittime))) + 
  geom_bar() +
  ggtitle("Number of patients admitted throughout different day in months") +
  xlab("Month Day") + ylab("Number of patients")
```
As kind of expected, towards the end there would be less patient being admitted due to the fact that there are less occurence of the 31st and the 30th throughout the year. Generally, the number of patients being admitted is pretty consistent.

```{r}
admissions_tble %>% 
  ggplot(aes(x = wday(admittime, label = TRUE))) + 
  geom_bar() +
  ggtitle("Number of patients admitted throughout different day in weeks") +
  xlab("Week Day") + ylab("Number of patients") +
  coord_cartesian(ylim = c(7000, 8000))
```
The graph above has already been zoomed so that we can observe the tip of the bar plot. Based on the look of it, Monday and Wednesday seem to be the busiest time for admission.

```{r}
admissions_tble %>% 
  ggplot(aes(x = hour(admittime))) + 
  geom_bar() +
  ggtitle("Number of patients admitted throughout different hours") +
  xlab("Hours") + ylab("Number of patients") 
  # coord_cartesian(ylim = c(70000, 80000)) 
```
Based on my observation, most patients are admitted in the evening or at night, peaking at midnight, as opposed to morning/afternoon. There is a peak at 7AM, which I guess is the time when the nurse change shift, so that's when they'll get to check in a lot of people into the hospital.

## Q4. `patients` data

Patient information is available in `patients.csv.gz`. See <https://mimic.mit.edu/docs/iv/modules/core/patients/> for details of each field in this file. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/core/patients.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `patients.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/core/patients/>) as a tibble `patients_tble` and only keep the patients who have a match in `icustays_tble` (according to `subject_id`).

```{r}
patients_tble <- read_csv("/mnt/mimiciv/1.0/core/patients.csv.gz") %>% 
  inner_join(icustays_tble, by="subject_id") %>% 
  select(-c(7:13)) %>% 
  print(width = Inf)
```

2. Summarize variables `gender` and `anchor_age`, and explain any patterns you see.

```{r}
by_gender <- group_by(patients_tble, gender)
df <- summarise(by_gender, avg_age = mean(anchor_age, na.rm = TRUE)) %>% 
  mutate(summarise(by_gender, med_age = median(anchor_age, na.rm = TRUE))) %>%  
  mutate(summarise(by_gender, max_age = max(anchor_age, na.rm = TRUE))) %>% 
  mutate(summarise(by_gender, min_age = min(anchor_age, na.rm = TRUE)))
df
```
```{r}
rm(df)
```

The oldest and youngest patients for either male or female are 91 and 18 respectively. On average, female are hospitalized at the age of 64, whereas male are hospitalized at the age of 62. That is a pretty interesting observation which may mean that older people need more intensive care when they are sick, thus the average and median age are in the range of 60+. The mean and median age for female patients are a bit higher than it is of male.

## Q5. Lab results

`labevents.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/hosp/labevents/>) contains all laboratory measurements for patients. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/hosp/labevents.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```
`d_labitems.csv.gz` is the dictionary of lab measurements. 
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/hosp/d_labitems.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Find how many rows are in `labevents.csv.gz`.
```{r}
labevents_tble <- 
  read_csv("/mnt/mimiciv/1.0/hosp/labevents_filtered_itemid.csv.gz",
     col_select = c(subject_id, itemid, charttime, valuenum),
     col_types = cols_only(subject_id = col_double(),
                           itemid = col_double(),
                           charttime = col_datetime(),
                           valuenum = col_double()),
     lazy = TRUE) %>%
  semi_join(icustays_tble, by = c("subject_id")) %>%
  print(width = Inf)
```
In `labevents_filtered_itemid.csv.gz` there are 16,698,462 rows.

```{r}
by_id <- group_by(labevents_tble, subject_id)
by_id
```
This means there are 53,097 distinct patients. Not all 53,150 patients are here in the filtered labevents data. 
```{r}
rm(by_id)
```

2. We are interested in the lab measurements of creatinine (50912), potassium (50971), sodium (50983), chloride (50902), bicarbonate (50882), hematocrit (51221), white blood cell count (51301), glucose (50931), magnesium (50960), and calcium (50893). Retrieve a subset of `labevents.csv.gz` only containing these items for the patients in `icustays_tble` as a tibble `labevents_tble`. 

    Hint: `labevents.csv.gz` is a data file too big to be read in by the `read_csv` function in its default setting. Utilize the `col_select` and `lazy` options in the `read_csv` function to reduce the memory burden.


3. Further restrict `labevents_tble` to the first lab measurement during the ICU stay. 
```{r}
labevents_tble <- labevents_tble %>% 
  left_join(select(icustays_tble, subject_id, intime), by = "subject_id") %>% 
  filter(charttime >= intime) %>%
  group_by(subject_id, itemid) %>% 
  arrange(charttime, .by_group = TRUE) %>%
  slice_head(n = 1) %>% #only take first measurement
  ungroup() %>%
  select(-charttime, -intime) %>% 
  pivot_wider(names_from = itemid, values_from = valuenum) %>%
  rename(creatinine = "50912", potassium = "50971", sodium = "50983",
         chloride = "50902", bicarbonate = "50882", hematocrit = "51221",
         wbc_count = "51301", glucose = "50931",
         magnesium = "50960", calcium = "50893") %>% 
  print(width = Inf)
```

4. Summarize the lab measurements by appropriate numerics and graphics. 
```{r}
sum_lab <- labevents_tble %>% 
  summarise(avg = c(mean(creatinine, na.rm = TRUE), 
                     mean(potassium, na.rm = TRUE),
                     mean(sodium, na.rm = TRUE),
                     mean(chloride, na.rm = TRUE),
                     mean(bicarbonate, na.rm = TRUE),
                     mean(hematocrit, na.rm = TRUE),
                     mean(wbc_count, na.rm = TRUE),
                     mean(glucose, na.rm = TRUE),
                     mean(magnesium, na.rm = TRUE),
                     mean(calcium, na.rm = TRUE)))
max <- summarise(labevents_tble, max = c(max(creatinine, na.rm = TRUE), 
                                         max(potassium, na.rm = TRUE),
                                         max(sodium, na.rm = TRUE),
                                         max(chloride, na.rm = TRUE),
                                         max(bicarbonate, na.rm = TRUE),
                                         max(hematocrit, na.rm = TRUE),
                                         max(wbc_count, na.rm = TRUE),
                                         max(glucose, na.rm = TRUE),
                                         max(magnesium, na.rm = TRUE),
                                         max(calcium, na.rm = TRUE)))
min <- summarise(labevents_tble, min = c(min(creatinine, na.rm = TRUE), 
                                         min(potassium, na.rm = TRUE),
                                         min(sodium, na.rm = TRUE),
                                         min(chloride, na.rm = TRUE),
                                         min(bicarbonate, na.rm = TRUE),
                                         min(hematocrit, na.rm = TRUE),
                                         min(wbc_count, na.rm = TRUE),
                                         min(glucose, na.rm = TRUE),
                                         min(magnesium, na.rm = TRUE),
                                         min(calcium, na.rm = TRUE)))
med <- summarise(labevents_tble, median = c(median(creatinine, na.rm = TRUE), 
                                         median(potassium, na.rm = TRUE),
                                         median(sodium, na.rm = TRUE),
                                         median(chloride, na.rm = TRUE),
                                         median(bicarbonate, na.rm = TRUE),
                                         median(hematocrit, na.rm = TRUE),
                                         median(wbc_count, na.rm = TRUE),
                                         median(glucose, na.rm = TRUE),
                                         median(magnesium, na.rm = TRUE),
                                         median(calcium, na.rm = TRUE)))
sum_lab <- sum_lab %>% 
  mutate(max, min, med) %>% 
  mutate(measurement = c("creatinine", "potassium",
                                           "sodium", "chloride", 
                                           "bicarbonate", "hematocrit",
                                           "wbc_count", "glucose",
                                           "magnesium", "calcium")) %>% 
  relocate(measurement, .before = avg) %>% 
  print(width = Inf)
rm(max, min, med)
```

## Q6. Vitals from charted events

`chartevents.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patient’s information is their electronic chart. The `itemid` variable indicates a single measurement type in the database. The `value` variable is the value measured for `itemid`. The first 10 lines of `chartevents.csv.gz` are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/chartevents.csv.gz")), 
    " | head"), 
  intern = TRUE
)
```
`d_items.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/d_items/>) is the dictionary for the `itemid` in `chartevents.csv.gz`. 
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/d_items.csv.gz")), 
    " | head"), 
  intern = TRUE
)
```

1. We are interested in the vitals for ICU patients: heart rate (220045), mean non-invasive blood pressure (220181), systolic non-invasive blood pressure (220179), body temperature in Fahrenheit (223761), and respiratory rate (220210). Retrieve a subset of `chartevents.csv.gz` only containing these items for the patients in `icustays_tble` as a tibble `chartevents_tble`.

```{r}
chartevents_tble <- 
  read_csv("/mnt/mimiciv/1.0/icu/chartevents_filtered_itemid.csv.gz",
     col_select = c(subject_id, itemid, charttime, valuenum),
     col_types = cols_only(subject_id = col_double(),
                           itemid = col_double(),
                           charttime = col_datetime(),
                           valuenum = col_double()),
     lazy = TRUE) %>%
semi_join(icustays_tble, by = c("subject_id")) %>%
print(width = Inf)
```

2. Further restrict `chartevents_tble` to the first vital measurement during the ICU stay. 
```{r}
chartevents_tble <- chartevents_tble %>% 
  left_join(select(icustays_tble, subject_id, intime), by = "subject_id") %>% 
  filter(charttime >= intime) %>%
  group_by(subject_id, itemid) %>% 
  arrange(charttime, .by_group = TRUE) %>%
  slice_head(n = 1) %>% #only take first measurement
  ungroup() %>%
  select(-charttime, -intime) %>% 
  pivot_wider(names_from = itemid, values_from = valuenum) %>%
  rename(heart_rate = "220045", mean_non_invasive_bp = "220181",
         systolic_non_invasive_bp = "220179", body_temp = "223761",
         resp_rate = "220210") %>%
  print(width = Inf)
```

3. Summarize these vital measurements by appropriate numerics and graphics. 
```{r}
sum_vit <- chartevents_tble %>% 
  summarise(avg = c(mean(heart_rate, na.rm = TRUE), 
                     mean(mean_non_invasive_bp, na.rm = TRUE),
                     mean(systolic_non_invasive_bp, na.rm = TRUE),
                     mean(body_temp, na.rm = TRUE),
                     mean(resp_rate, na.rm = TRUE)))
max <- summarise(chartevents_tble, 
                 max = c(max(heart_rate, na.rm = TRUE), 
                         max(mean_non_invasive_bp, na.rm = TRUE),
                         max(systolic_non_invasive_bp, na.rm = TRUE),
                         max(body_temp, na.rm = TRUE),
                         max(resp_rate, na.rm = TRUE)))
min <- summarise(chartevents_tble, 
                 min = c(min(heart_rate, na.rm = TRUE), 
                         min(mean_non_invasive_bp, na.rm = TRUE),
                         min(systolic_non_invasive_bp, na.rm = TRUE),
                         min(body_temp, na.rm = TRUE),
                         min(resp_rate, na.rm = TRUE)))
med <- summarise(chartevents_tble, 
                 median = c(median(heart_rate, na.rm = TRUE), 
                         median(mean_non_invasive_bp, na.rm = TRUE),
                         median(systolic_non_invasive_bp, na.rm = TRUE),
                         median(body_temp, na.rm = TRUE),
                         median(resp_rate, na.rm = TRUE)))

sum_vit <- sum_vit %>% 
  mutate(max, min, med) %>% 
  mutate(vitals = c("Heart Rate", "Mean non-invasive BP",
                    "Systolic non-invasive BP", "Body Temperature", 
                    "Respiration Rate")) %>% 
  relocate(vitals, .before = avg) %>% 
  print(width = Inf)
rm(max, min, med)
```


## Q7. Putting things together

Let us create a tibble `mimic_icu_cohort` for all ICU stays, where rows are  

- first ICU stay of each unique adult (age at admission > 18)

and columns contain at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- all variables in `patients.csv.gz`  
- first lab measurements during ICU stay  
- first vital measurements during ICU stay
- an indicator variable `thirty_day_mort` whether the patient died within 30 days of hospital admission (30 day mortality)

**Solution**
```{r}
mimic_icu_cohort <- 
  left_join(icustays_tble, patients_tble, by = "subject_id") %>% 
  left_join(admissions_tble, by = c("subject_id", "hadm_id")) %>% 
  left_join(labevents_tble, by = "subject_id") %>% 
  left_join(chartevents_tble, by = "subject_id") %>% 
  mutate(age_hadm = anchor_age + year(admittime) - anchor_year) %>% 
  filter(age_hadm > 18) %>% 
  mutate(shinda = difftime(deathtime, admittime, units = c("days"))) %>% 
  mutate(shinda = replace_na(shinda, ddays(0))) %>%  #replace all NAs with 0
  mutate(thirty_days_mort = ifelse(shinda < 30 & shinda != 0, "Yes", "No")) %>%
  select(-shinda) %>% 
  print(width = Inf)
```
```{r}
count <- count(mimic_icu_cohort, thirty_days_mort)
mean(mimic_icu_cohort$admittime, na.rm = TRUE)
```


## Q8. Exploratory data analysis (EDA)

Summarize following information using appropriate numerics or graphs.

- `thirty_day_mort` vs demographic variables (ethnicity, language, insurance, marital_status, gender, age at hospital admission)

- `thirty_day_mort` vs first lab measurements

- `thirty_day_mort` vs first vital measurements

- `thirty_day_mort` vs first ICU unit